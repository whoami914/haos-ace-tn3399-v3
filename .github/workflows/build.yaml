name: Build DTB Only for TN3399-V3

on:
  workflow_dispatch:
    inputs:
      kernel_version:
        description: 'Kernel Version (e.g. 6.12.35)'
        required: true
        default: '6.12.35'

jobs:
  build-dtb:
    runs-on: ubuntu-latest
    env:
      KERNEL_VERSION: ${{ github.event.inputs.kernel_version }}
      KERNEL_SRC_DIR: /home/runner/work/tn3399-dtb/linux-src
      DTB_TARGET: arch/arm64/boot/dts/rockchip/rk3399-tn3399-v3.dtb
      CROSS_COMPILE: aarch64-linux-gnu-
      ARCH: arm64

    steps:
      - name: Checkout Repo (Minimal)
        uses: actions/checkout@v4
        with:
          repository: jac0bz1980/haos-ace-tn3399-v3
          path: tn3399-repo
          fetch-depth: 1

      - name: Cache Kernel Src & Toolchain
        uses: actions/cache@v3
        with:
          path: |
            /usr/bin/aarch64-linux-gnu-*
            ${{ env.KERNEL_SRC_DIR }}
            ${{ env.KERNEL_SRC_DIR }}/.config
          key: ${{ runner.os }}-dtb-cache-${{ env.KERNEL_VERSION }}
          restore-keys: |
            ${{ runner.os }}-dtb-cache-

      # 关键修改：删除 device-tree-compiler/dtc，只装必需工具
      - name: Install Minimal Dependencies (No DTC)
        run: |
          sudo apt update -y && sudo apt install -y \
            gcc-aarch64-linux-gnu make bc flex bison git  # 去掉所有 dtc 相关包
          # 验证交叉工具链，确保基础环境正常
          ${{ env.CROSS_COMPILE }}gcc --version

      - name: Fetch Kernel Source (Cacheable)
        run: |
          mkdir -p $(dirname ${{ env.KERNEL_SRC_DIR }})
          if [ ! -d "${{ env.KERNEL_SRC_DIR }}" ]; then
            git clone --branch linux-${{ env.KERNEL_VERSION }} \
              --depth 1 \
              https://github.com/rockchip-linux/kernel.git ${{ env.KERNEL_SRC_DIR }}
          fi

      - name: Generate Kernel Config (DTB Only)
        run: |
          cd ${{ env.KERNEL_SRC_DIR }}
          if [ ! -f ".config" ]; then
            # 优先用板卡配置，没有就用 RK3399 通用配置
            if [ -f "arch/${{ env.ARCH }}/configs/tn3399_v3_defconfig" ]; then
              make tn3399_v3_defconfig
            else
              make rockchip_defconfig
            fi
          fi

      # 核心修复：强制用内核自带的 DTC 编译器，不依赖系统
      - name: Build Target DTB (Use Kernel's DTC)
        run: |
          cd ${{ env.KERNEL_SRC_DIR }}
          # 增加 DTC 路径参数，指定用内核源码里的编译器
          make -j$(nproc) ARCH=${{ env.ARCH }} CROSS_COMPILE=${{ env.CROSS_COMPILE }} \
            DTC=${{ env.KERNEL_SRC_DIR }}/scripts/dtc/dtc \
            ${{ env.DTB_TARGET }}
          # 验证结果
          echo "DTB Compile Result:"
          ls -l ${{ env.DTB_TARGET }}
          file ${{ env.DTB_TARGET }}

      - name: Upload DTB Artifact
        uses: actions/upload-artifact@v4
        with:
          name: tn3399-v3-dtb-${{ env.KERNEL_VERSION }}
          path: ${{ env.KERNEL_SRC_DIR }}/${{ env.DTB_TARGET }}
          retention-days: 7
